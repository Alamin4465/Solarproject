<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡ßã‡¶≤‡¶æ‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° - ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶æ‡¶∞</title>
    
    <!-- CSS FILES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
       
    </style>
</head>
<body>
    <!-- Loader / Auth Checking -->
    <div id="authChecking">
        <div class="loader-content">
            <div class="spinner"></div>
            <h2>üîê ‡¶≤‡¶ó‡¶á‡¶® ‡¶ö‡ßá‡¶ï ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</h2>
            <p>‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <small id="authStatus">Firebase ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</small>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="container" id="dashboard" style="display: none;">
        <header>
            <div class="header_file">
                <h1><i class="fas fa-sun"></i> Solar Smart Controller</h1>
                <p>Embedded IoT Solar Panel Monitoring & Control System</p>
            </div>
            <div class="user-info-display">
                    <i class="fas fa-user-circle"></i>
                    <span id="userEmailDisplay">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á</span>
                    <button onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
                    </button>
                </div>
                <div class="connection-status">
                    <span id="connectionIndicator" class="connection-dot disconnected"></span>
                    <span id="cloud_status">‚òÅÔ∏è ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                </div>
                <div id="systemTime" class="system-time">--:--:--</div>
        </header>
        
                <!-- ================= SAFETY ALERT ================= -->
        <div id="safety_alert" class="safety-alert"></div>


       <!-- ================= STATUS BAR ================= -->
		<div class="status-bar">
			<div class="status-items-left">
				<!-- ‡¶Æ‡ßã‡¶° -->
			    <div class="status-item">
					<div class="status-item-left">
					      <i class="fas fa-robot"></i>
					       <span class="status-label">‡¶Æ‡ßã‡¶°:</span>
					</div>
                <div class="status-value">
                    <span id="mode_indicator" class="auto-indicator">‡¶Ö‡¶ü‡ßã ‡¶Æ‡ßã‡¶°</span>
                </div>
        </div>
        
        <!-- ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï -->
        <div class="status-item">
            <div class="status-item-left">
                <i class="fas fa-wifi"></i>
                <span class="status-label">‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï:</span>
            </div>
            <div class="status-value">
                <span class="network-status connected">‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</span>
            </div>
        </div>
        
        <!-- ‡¶ß‡ßÅ‡¶≤‡¶æ -->
        <div class="status-item">
            <div class="status-item-left">
                <i class="fas fa-wind"></i>
                <span class="status-label">‡¶ß‡ßÅ‡¶≤‡¶æ:</span>
            </div>
            <div class="status-value">
                <span id="dust">0 Œºg/m¬≥</span>
            </div>
        </div>
        
        <!-- ‡¶¶‡¶ï‡ßç‡¶∑‡¶§‡¶æ -->
        <div class="status-item">
            <div class="status-item-left">
                <i class="fas fa-leaf"></i>
                <span class="status-label">‡¶¶‡¶ï‡ßç‡¶∑‡¶§‡¶æ:</span>
            </div>
            <div class="status-value">
                <span id="efficiency">0%</span>
            </div>
        </div>
        
        <!-- SOC -->
        <div class="status-item">
            <div class="status-item-left">
                <i class="fas fa-battery-half"></i>
                <span class="status-label">SOC:</span>
            </div>
            <div class="status-value">
                <i class="fas fa-bolt" id="chargingIndicator" style="display: none;"></i>
                <span class="battery_soc"></span>
            </div>
        </div>
    </div>
</div>


        <!-- ================= BATTERY STATUS ================= -->
        <div class="battery-status-card">
            <div class="card-header">
                <h3><i class="fas fa-battery-full"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</h3>
            </div>
            <div class="card-body">
                <div class="battery-display">
                    <div class="battery-percentage">
                        <span class="percentage-value battery_soc">0</span>
                        <span class="percentage-symbol"></span>
                    </div>
                    <div class="battery-progress">
                        <div class="battery-progress-track">
                            <div id="batteryProgressBar" class="battery-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="battery-labels">
                            <span>0%</span>
                            <span>25%</span>
                            <span>50%</span>
                            <span>75%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <div class="battery-info-row">
                        <div class="battery-info-item">
                            <div class="info-label">‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú</div>
                            <div class="info-value battery_v">0.00<span class="unit">V</span></div>
                        </div>
                        <div class="battery-info-item">
                            <div class="info-label">‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø</div>
                            <div id="batteryHealthStatus" class="info-value health-text">‡¶∏‡ßÅ‡¶∏‡ßç‡¶•</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ================= CURRENT SOURCE ================= -->
        <div class="current-source">
            ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßã‡¶∞‡ßç‡¶∏: <span id="currentPowerSource">‡¶∏‡ßã‡¶≤‡¶æ‡¶∞ ‚Üí ‡¶≤‡ßã‡¶°</span>
        </div>
        
        <!-- ================= POWER FLOW DIAGRAM ================= -->
        <div class="power-flow-path" id="powerFlowDiagram">
            <div class="path-item active" data-id="solar">[SOLAR]</div>
            <span class="path-arrow active" data-from="solar">‚Üí</span>
            <div class="path-item" data-id="battery">[BATTERY]</div>
            <span class="path-arrow" data-from="battery">‚Üí</span>
            <div class="path-item active" data-id="load">[LOAD]</div>
            <span class="path-arrow" data-from="load">‚Üî</span>
            <div class="path-item" data-id="grid">[GRID]</div>
        </div>

        <!-- ================= POWER PARAMETERS ================= -->
        <div class="power-parameters-card">
            <div class="card-header">
                <h3><i class="fas fa-bolt"></i> ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡¶∏</h3>
            </div>
            <div class="card-body">
                <div class="parameters-grid">
                    <!-- Solar -->
                    <div class="parameter-group solar-group">
                        <h4><i class="fas fa-solar-panel"></i> ‡¶∏‡ßã‡¶≤‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h4>
                        <div class="parameter-item">
                            <span class="param-label">‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú</span>
                            <span class="param-value solar_v">0.00<span class="unit">V</span></span>
                        </div>
                        <div class="parameter-item">
                            <span class="param-label">‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü</span>
                            <span class="param-value solar_a">0.00<span class="unit">A</span></span>
                        </div>
                        <div class="parameter-item">
                            <span class="param-label">‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞</span>
                            <span class="param-value solar_w">0.00<span class="unit">W</span></span>
                        </div>
                        <div class="parameter-item full-width">
                            <span class="param-label">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡¶æ‡¶∞‡ßç‡¶ú‡¶ø</span>
                            <span class="param-value" id="total_energy">0.00<span class="unit">Wh</span></span>
                        </div>
                    </div>

                    <!-- Battery -->
                    <div class="parameter-group battery-group">
                        <h4><i class="fas fa-car-battery"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø</h4>
                        <div class="parameter-item">
                            <span class="param-label">‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú</span>
                            <span class="param-value battery_v">0.00<span class="unit">V</span></span>
                        </div>
                        <div class="parameter-item">
                            <span class="param-label">‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü</span>
                            <span class="param-value battery_a">0.00<span class="unit">A</span></span>
                        </div>
                        <div class="parameter-item">
                            <span class="param-label">‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞</span>
                            <span class="param-value battery_w">0.00<span class="unit">W</span></span>
                        </div>
                    </div>

                    <!-- Load -->
                    <div class="parameter-group load-group">
                        <h4><i class="fas fa-plug"></i> ‡¶≤‡ßã‡¶°</h4>
                        <div class="parameter-item">
                            <span class="param-label">‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú</span>
                            <span class="param-value load_v">0.00<span class="unit">V</span></span>
                        </div>
                        <div class="parameter-item">
                            <span class="param-label">‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü</span>
                            <span class="param-value load_a">0.00<span class="unit">A</span></span>
                        </div>
                        <div class="parameter-item">
                            <span class="param-label">‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞</span>
                            <span class="param-value load_w">0.00<span class="unit">W</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= CONTROL PANEL ================= -->
        <div class="control-panel-card">
            <div class="card-header">
                <h3><i class="fas fa-cogs"></i> ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h3>
            </div>
            <div class="card-body">
                <div class="control-panel-grid">
                    <!-- Mode Control Section -->
                    <div class="control-section">
                        <div class="control-group mode-control-group">
                            <h4><i class="fas fa-sliders-h"></i> ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Æ‡ßã‡¶°</h4>
                            <div class="mode-control-buttons">
                                <button class="mode-control-btn active" id="autoModeBtn">
                                    <i class="fas fa-robot"></i> Auto
                                </button>
                                <button class="mode-control-btn" id="manualModeBtn">
                                    <i class="fas fa-hand-paper"></i> Manual
                                </button>
                                <button class="mode-control-btn stop" id="stopModeBtn">
                                    <i class="fas fa-stop-circle"></i> Stop
                                </button>
                            </div>
                        </div>

                        <!-- Manual Control Panel (Hidden by default) -->
                        <div id="manualControlPanel" class="manual-control-panel" style="display: none;">
                            <div class="control-group">
                                <h4><i class="fas fa-sync-alt"></i> ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßã ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤</h4>
                                <div class="servo-control-buttons">
    <!-- ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶≤‡¶æ‡¶á‡¶®: ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶â‡¶™‡¶∞‡ßá (‡¶Æ‡¶æ‡¶ù‡ßá) -->
    <button class="servo-control-btn" data-direction="up" data-angle="5">
        <i class="fas fa-arrow-up"></i> ‡¶â‡¶™‡¶∞‡ßá
    </button>
    
    <!-- ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶≤‡¶æ‡¶á‡¶®: ‡¶¨‡¶æ‡¶Æ‡ßá, ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞, ‡¶°‡¶æ‡¶®‡ßá -->
    <button class="servo-control-btn" data-direction="left" data-angle="5">
        <i class="fas fa-arrow-left"></i> ‡¶¨‡¶æ‡¶Æ‡ßá
    </button>
    
    <button class="servo-control-btn reset" data-direction="center" data-angle="90">
        <i class="fas fa-home"></i> ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞
    </button>
    
    <button class="servo-control-btn" data-direction="right" data-angle="5">
        ‡¶°‡¶æ‡¶®‡ßá <i class="fas fa-arrow-right"></i>
    </button>
    
    <!-- ‡¶§‡ßÉ‡¶§‡ßÄ‡ßü ‡¶≤‡¶æ‡¶á‡¶®: ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶ø‡¶ö‡ßá (‡¶Æ‡¶æ‡¶ù‡ßá) -->
    <button class="servo-control-btn" data-direction="down" data-angle="5">
        ‡¶®‡¶ø‡¶ö‡ßá <i class="fas fa-arrow-down"></i>
    </button>
</div>
                     
                            </div>

                            <div class="control-group">
                                <h4><i class="fas fa-power-off"></i> ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü</h4>
                                <div class="power-source-buttons">
                                    <button class="power-source-btn solar-on" data-source="solar" data-state="on">
                                        <i class="fas fa-sun"></i> ‡¶∏‡ßã‡¶≤‡¶æ‡¶∞ ON
                                    </button>
                                    <button class="power-source-btn battery-on" data-source="battery" data-state="on">
                                        <i class="fas fa-battery-full"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø ON
                                    </button>
                                    <button class="power-source-btn grid-on" data-source="grid" data-state="on">
                                        <i class="fas fa-bolt"></i> ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ON
                                    </button>
                                    <button class="power-source-btn all-off" data-source="all" data-state="off">
                                        <i class="fas fa-power-off"></i> ‡¶∏‡¶¨ OFF
                                    </button>
                                </div>
                            </div>

                            <!-- ‡¶¨‡ßç‡¶∞‡¶æ‡¶∂ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
                            <div class="control-group brush-control-group">
                                <h4><i class="fas fa-broom"></i> ‡¶¨‡ßç‡¶∞‡¶æ‡¶∂ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤</h4>
                                
                                <!-- ‡¶Æ‡ßã‡¶° ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® -->
                                <div class="brush-mode-selection">
                                    <button class="brush-mode-btn active" id="brushAutoModeBtn">
                                        <i class="fas fa-robot"></i> ‡¶Ö‡¶ü‡ßã ‡¶Æ‡ßã‡¶°
                                    </button>
                                    <button class="brush-mode-btn" id="brushManualModeBtn">
                                        <i class="fas fa-hand-point-up"></i> ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Æ‡ßã‡¶°
                                    </button>
                                </div>
                                
                                <!-- ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® -->
                                <div id="manualBrushControl" class="manual-brush-control" style="display: none;">
                                    <div class="manual-buttons-grid">
                                        <button class="manual-control-btn forward" id="brushForwardBtn">
                                            <i class="fas fa-forward"></i> ‡¶¨‡ßç‡¶∞‡¶æ‡¶∂ ‡¶´‡¶∞‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°
                                        </button>
                                        <button class="manual-control-btn reverse" id="brushReverseBtn">
                                            <i class="fas fa-backward"></i> ‡¶¨‡ßç‡¶∞‡¶æ‡¶∂ ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏
                                        </button>
                                        <button class="manual-control-btn pump" id="pumpOnBtn">
                                            <i class="fas fa-tint"></i> ‡¶™‡¶æ‡¶Æ‡ßç‡¶™ ON
                                        </button>
                                        <button class="manual-control-btn stop" id="brushPumpStopBtn">
                                            <i class="fas fa-stop"></i> ‡¶Ö‡¶´ ‡¶¨‡ßç‡¶∞‡¶æ‡¶∂/‡¶™‡¶æ‡¶Æ‡ßç‡¶™
                                        </button>
                                    </div>
                                    
                                    <!-- ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
                                    <div class="brush-status-display">
                                        <div class="status-item">
                                            <span class="status-label">‡¶¨‡ßç‡¶∞‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</span>
                                            <span id="brushStatus" class="status-value">‡¶¨‡¶®‡ßç‡¶ß</span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-label">‡¶™‡¶æ‡¶Æ‡ßç‡¶™ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</span>
                                            <span id="pumpStatus" class="status-value">‡¶¨‡¶®‡ßç‡¶ß</span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-label">‡¶¨‡ßç‡¶∞‡¶æ‡¶∂ ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡¶∂‡¶®:</span>
                                            <span id="brushDirection" class="status-value">-</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ‡¶Ö‡¶ü‡ßã ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® -->
                                <div id="autoBrushControl" class="auto-brush-control">
                                    
                                    <!-- ‡¶Ö‡¶ü‡ßã ‡¶Æ‡ßã‡¶° ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ -->
                                    <div class="auto-settings">
                                        <div class="setting-item">
                                            <label for="cleaningDuration">
                                                <i class="fas fa-clock"></i> ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º (‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°):
                                            </label>
                                            <input type="number" id="cleaningDuration" value="30" min="10" max="300">
                                        </div>
                                        <div class="setting-item">
                                            <label for="cleaningInterval">
                                                <i class="fas fa-history"></i> ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø (‡¶ò‡¶£‡ßç‡¶ü‡¶æ):
                                            </label>
                                            <input type="number" id="cleaningInterval" value="6" min="1" max="24">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= CHARTS SECTION ================= -->
        <div class="charts-section">
            <h2><i class="fas fa-chart-line"></i> ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏</h2>
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-bolt"></i> ‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°</h3>
                        <div class="chart-legend">
                            <span class="legend-item solar">‡¶∏‡ßã‡¶≤‡¶æ‡¶∞</span>
                            <span class="legend-item battery">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø</span>
                            <span class="legend-item load">‡¶≤‡ßã‡¶°</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="voltageChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-tachometer-alt"></i> ‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°</h3>
                        <div class="chart-legend">
                            <span class="legend-item solar">‡¶∏‡ßã‡¶≤‡¶æ‡¶∞</span>
                            <span class="legend-item battery">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø</span>
                            <span class="legend-item load">‡¶≤‡ßã‡¶°</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="currentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= HISTORY & ALERTS SECTION ================= -->
        <div class="history-alerts-section">
            <!-- History Table -->
            <div class="history-card">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> ‡¶°‡¶æ‡¶ü‡¶æ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h3>
                    <span class="last-update" id="last_sync">--:--:--</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>‡¶∏‡¶Æ‡¶Ø‡¶º</th>
                                    <th>‡¶∏‡ßã‡¶≤‡¶æ‡¶∞ (V)</th>
                                    <th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø (V)</th>
                                    <th>‡¶∏‡ßã‡¶≤‡¶æ‡¶∞ (A)</th>
                                    <th>SOC (%)</th>
                                    <th>‡¶ß‡ßÅ‡¶≤‡¶æ</th>
                                </tr>
                            </thead>
                            <tbody id="history_body">
                                <tr>
                                    <td colspan="6" class="loading">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alerts Panel -->
            <div class="alerts-card">
                <div class="card-header">
                    <h3><i class="fas fa-bell"></i> ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü‡¶∏</h3>
                    <span class="alerts-count" id="alertsCount">0</span>
                </div>
                <div class="card-body">
                    <div id="recent_alerts" class="alerts-container">
                        <div class="alert-empty">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= FOOTER ================= -->
        <div class="footer">
            <div class="footer-left">
                <div class="device-info">
                    <i class="fas fa-microchip"></i>
                    <span>‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ID: <span id="device_id">ESP32_SOLAR_001</span></span>
                </div>
                <div class="version-info">
                    <i class="fas fa-code-branch"></i>
                    <span>‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®: 2.1.0</span>
                </div>
            </div>
            <div class="footer-right">
                <div class="copyright">
                    ¬© 2024 Solar Smart Controller | Embedded IoT System
                </div>
                <div class="status-indicators">
                    <span class="status-indicator">
                        <i class="fas fa-database"></i>
                        <span id="dataStatus">‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                    </span>
                    <span class="status-indicator">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span id="syncStatus">‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notification"></div>

    <!-- JS FILES -->
    <script src="firebaseConfig.js"></script>
    <script src="auth.js"></script>
    <script src="dashboard.js"></script>
    
    <script>
    // Wait for DOM and Firebase to be ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log("üìÑ Solar.html loaded");
        
        // First, wait for Firebase SDK to load
        const checkFirebaseLoaded = setInterval(() => {
            if (typeof firebase !== 'undefined' && 
                typeof firebase.initializeApp !== 'undefined' &&
                typeof firebaseConfig !== 'undefined') {
                
                clearInterval(checkFirebaseLoaded);
                console.log("‚úÖ Firebase SDK loaded, initializing...");
                initializeAuth();
            }
        }, 100);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            clearInterval(checkFirebaseLoaded);
            console.error("‚ùå Firebase SDK loading timeout");
            document.getElementById('authStatus').textContent = 
                "Firebase ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        }, 10000);
    });
    
    function initializeAuth() {
        const loader = document.getElementById('authChecking');
        const dashboard = document.getElementById('dashboard');
        const authStatus = document.getElementById('authStatus');
        
        // 1. Initialize Firebase
        if (!initializeFirebase()) {
            authStatus.textContent = "Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ";
            console.error("‚ùå Firebase initialization failed");
            
            // Show retry button
            const retryBtn = document.createElement('button');
            retryBtn.textContent = "‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®";
            retryBtn.className = 'retry-btn';
            retryBtn.onclick = function() {
                location.reload();
            };
            loader.querySelector('.loader-content').appendChild(retryBtn);
            return;
        }
        
        authStatus.textContent = "‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        
        // 2. Check if user is logged in via localStorage first (faster)
        const isLoggedInLocal = localStorage.getItem("solar_user_logged_in") === "true";
        
        if (!isLoggedInLocal) {
            // Not logged in locally, redirect immediately
            console.log("‚ùå Not logged in (localStorage), redirecting...");
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 500);
            return;
        }
        
        // 3. Check Firebase auth state
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in
                console.log("‚úÖ User authenticated:", user.email);
                
                // Update UI
                if (loader) loader.style.display = 'none';
                if (dashboard) dashboard.style.display = 'block';
                
                // Set user info
                const userEmailDisplay = document.getElementById('userEmailDisplay');
                if (userEmailDisplay) {
                    userEmailDisplay.textContent = user.displayName || user.email;
                }
                
                // Now load dashboard functionality
                loadDashboardFunctionality();
                
            } else {
                // User is signed out
                console.log("‚ùå Firebase auth failed, redirecting...");
                
                // Clear local storage
                localStorage.clear();
                
                // Redirect to login
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }
        });
        
        // Set timeout for auth check
        setTimeout(() => {
            const user = firebase.auth().currentUser;
            if (!user) {
                console.log("‚ö†Ô∏è Auth check timeout, checking localStorage...");
                authStatus.textContent = "‡¶Ö‡¶ü‡ßã ‡¶∞‡¶ø‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }
        }, 5000);
    }
    
    function loadDashboardFunctionality() {
        console.log("üìä Loading dashboard functionality...");
        
        // Initialize dashboard from dashboard.js
        if (typeof initializeDashboard === 'function') {
            initializeDashboard();
        } else {
            console.error("‚ùå initializeDashboard function not found");
            showNotification("‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ", "error");
        }
    }
    
    function logout() {
        if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            showNotification("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "info");
            
            firebase.auth().signOut()
            .then(() => {
                // Clear local storage
                localStorage.clear();
                showNotification("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            })
            .catch(error => {
                console.error("Logout error:", error);
                showNotification("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
            });
        }
    }
    
    // Simple notification function as fallback
    function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.className = type;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    // Export functions
    window.logout = logout;
    window.showNotification = showNotification;
    </script>
    
</body>
</html>
